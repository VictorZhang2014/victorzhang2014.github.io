<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="google-site-verification" content="" />
  
  <title>iOSä¸­çš„é”</title>
  <meta name="author" content="Victor Zhang">
  <meta name="description" content="iOS,é€†å‘å·¥ç¨‹,AI,.NET">
  
  
  <meta property="og:title" content="iOSä¸­çš„é”"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:site_name" content="Simple, but perfect"/>
  <link href="/apple-touch-icon-precomposed.png" sizes="180x180" rel="apple-touch-icon-precomposed">
  <link rel="alternate" href="/atom.xml" title="Simple, but perfect" type="application/atom+xml">
  <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/m.min.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>

<body>
  <a id="top"></a>
  <div id="main">
    <div class="behind">
      <a href="/" class="back black-color">
        <svg class="i-close" viewBox="0 0 32 32" width="22" height="22" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3">
            <path d="M2 30 L30 2 M30 30 L2 2"></path>
        </svg>
      </a>
      <div class="description">
        &nbsp;What will you do if you weren't afraid ? 
      </div>
    </div>
    <div class="container">
      

  <article class="standard post">
    <div class="title">
      
  
    <h1 class="page-title center">
        iOSä¸­çš„é”
    </h1>
  


    </div>
    <div class="meta center">
      
<time datetime="2017-10-15T09:30:34.000Z">
<svg class="i-calendar" viewBox="0 0 32 32" width="14" height="14" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
    <path d="M2 6 L2 30 30 30 30 6 Z M2 15 L30 15 M7 3 L7 9 M13 3 L13 9 M19 3 L19 9 M25 3 L25 9"></path>
  </svg>
  &nbsp;
  2017-10-15
</time>



    
    &nbsp;
    <svg class="i-tag" viewBox="0 0 32 32" width="14" height="14" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
      <circle cx="24" cy="8" r="2"></circle>
      <path d="M2 18 L18 2 30 2 30 14 14 30 Z"></path>
    </svg>
    &nbsp;
    <a href="/categories/iOS/">iOS</a>




    
    &nbsp;
    <svg class="i-tag" viewBox="0 0 32 32" width="14" height="14" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
      <circle cx="24" cy="8" r="2"></circle>
      <path d="M2 18 L18 2 30 2 30 14 14 30 Z"></path>
    </svg>
    &nbsp;
    <a href="/tags/NSLock-NSCondition-NSRecursiveLock-NSConditionLock-pthread-mutex-dispatch-semaphore/">NSLock, NSCondition, NSRecursiveLock, NSConditionLock, pthread_mutex, dispatch_semaphore</a>


    </div>
    <hr>
    <div class="picture-container">
      
    </div>
    <h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>åœ¨<code>å¤šçº¿ç¨‹ç¼–ç¨‹</code>ä¸­ï¼Œå¹¶å‘ä¼šä½¿<code>ä¸€æ®µä»£ç </code>åœ¨<code>åŒä¸€æ®µæ—¶é—´</code>å†…çº¿ç¨‹ä¹‹é—´äº’ç›¸<code>äº‰æŠ¢èµ„æº</code>ï¼ˆ<code>èµ„æºå…±äº«</code>ï¼‰è€Œäº§ç”Ÿ<code>æ•°æ®</code>çš„<code>ä¸ä¸€è‡´æ€§</code>ï¼Œä¸ºäº†<code>è§£å†³</code>è¿™ä¸ªé—®é¢˜ï¼Œå°±<code>å¼•å…¥</code>äº†<code>é”</code>ã€‚é”çš„ç±»å‹æœ‰å¤šç§ï¼Œåœ¨iOSä¸­ï¼Œæœ‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>1.OSSpinLock    è‡ªæ—‹é”</li>
<li>2.dispatch_semaphore    GCDä¿¡å·é‡å®ç°åŠ é”</li>
<li>3.pthread_mutex    äº’æ–¥é”</li>
<li>4.NSLock  äº’æ–¥é”</li>
<li>5.NSCondition    ä¿¡å·é”</li>
<li>6.pthread_mutex(recursive)  é€’å½’äº’æ–¥é”</li>
<li>7.NSRecursiveLock  é€’å½’é”</li>
<li>8.NSConditionLock  æ¡ä»¶é”</li>
<li>9.@synchronized  äº’æ–¥é”</li>
</ul>
<p>åœ¨çœ‹æœ¬ç¯‡æ–‡ç« å‰ï¼Œè¯·å…ˆäº†è§£<a href="/2017/10/15/GCDçš„ä¸€èˆ¬è®¤çŸ¥/"><code>GCD</code></a>å’Œ<a href="/2017/10/15/NSOperationçš„è®¤çŸ¥/"><code>NSOperation</code></a>, å¦‚æœä½ å·²ç†ŸçŸ¥ï¼Œè¯·ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹iOSä¸­å…¨éƒ¨çš„é”ï¼Œä»¥åŠå®ƒä»¬çš„æ•ˆç‡<br><img src="/img/iOS/lock/iOS_lock_summary_benchmark.png" alt="iOS ä¸­å…¨éƒ¨çš„é”"></p>
<p>è¿™ä¸ªç®€å•çš„æ€§èƒ½æµ‹è¯•æ˜¯åœ¨iPhone 6, iOS 9ä¸Šè·‘çš„ï¼Œ<a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/" target="_blank" rel="noopener">æµ‹è¯•è€…åœ¨è¿™ç¯‡æ–‡ç« </a><br>è¯¥ç»“æœæ˜¾ç¤ºçš„ï¼Œæ¨ªå‘æŸ±çŠ¶æ¡æœ€çŸ­çš„ä¸ºæ€§èƒ½æœ€ä½³å’Œæœ€é«˜ï¼›å¯çŸ¥ï¼ŒOSSpinLockæœ€ä½³ï¼Œä½†æ˜¯OSSpinLockè¢«å‘ç°bugï¼ŒAppleå·¥ç¨‹å¸ˆé€éœ²äº†è¿™ä¸ªè‡ªæ—‹é”æœ‰é—®é¢˜ï¼Œæš‚æ—¶åœç”¨äº†ï¼Œ<a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/" target="_blank" rel="noopener">æŸ¥çœ‹è¿™é‡Œ</a><br>è™½ç„¶OSSpinLockï¼ˆè‡ªæ—‹é”ï¼‰æœ‰é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯çœ‹åˆ°äº†<code>pthread_mutex</code>å’Œ<code>dispatch_semaphore</code>æ€§èƒ½æ’è¡Œä»æ˜¯å¾ˆé«˜ï¼Œè€Œä¸”è‹¹æœåœ¨æ–°ç³»ç»Ÿä¸­ä¹Ÿå·²ç»ä¼˜åŒ–äº†<br>è¿™ä¸¤ä¸ªé”çš„æ€§èƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å¼€å‘æ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒä»¬å•¦ã€‚</p>
<p>ä¸‹é¢æ¥ä¸€ä¸€ä»‹ç»å®ƒä»¬çš„ä½¿ç”¨</p>
<p><br></p>
<h2 id="1-dispatch-semaphore-GCDä¿¡å·é‡å®ç°åŠ é”"><a href="#1-dispatch-semaphore-GCDä¿¡å·é‡å®ç°åŠ é”" class="headerlink" title="1.dispatch_semaphore    GCDä¿¡å·é‡å®ç°åŠ é”"></a>1.dispatch_semaphore    GCDä¿¡å·é‡å®ç°åŠ é”</h2><p>GCDä¸­æä¾›äº†ä¸€ç§<code>ä¿¡å·æœºåˆ¶</code>ï¼Œä¹Ÿæ˜¯ä¸ºäº†<code>è§£å†³</code>èµ„æº<code>æŠ¢å é—®é¢˜</code>çš„ï¼Œæ”¯æŒ<code>ä¿¡å·é€šçŸ¥</code>å’Œ<code>ä¿¡å·ç­‰å¾…</code>ã€‚</p>
<ul>
<li>1.æ¯å½“<code>å‘é€</code>ä¸€ä¸ª<code>ä¿¡å·</code>æ—¶ï¼Œåˆ™<code>ä¿¡å·é‡åŠ 1</code></li>
<li>2.æ¯å½“<code>å‘é€</code>ä¸€ä¸ª<code>ç­‰å¾…ä¿¡å·</code>æ—¶ï¼Œåˆ™<code>ä¿¡å·é‡å‡1</code></li>
<li>3.å¦‚æœ<code>ä¿¡å·é‡ä¸º0</code>ï¼Œåˆ™ä¿¡å·ä¼šå¤„äº<code>ç­‰å¾…çŠ¶æ€</code>ï¼Œç›´åˆ°ä¿¡å·é‡<code>å¤§äº0</code>æ—¶å°±å¼€å§‹æ‰§è¡Œ</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">- (void)example &#123;</span><br><span class="line"></span><br><span class="line">    //å‡è®¾ä¸€å…±ç”µå½±ç¥¨3å¼ ç¥¨</span><br><span class="line">    self.movieTickets = 3;</span><br><span class="line">    </span><br><span class="line">    //åˆ›å»ºä¿¡å·é‡</span><br><span class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(1);</span><br><span class="line">    </span><br><span class="line">    //æ·»åŠ ä»»åŠ¡1</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">        [self buyTicketWithCounts:2 taskName:@&quot;ä»»åŠ¡1&quot; semaphore:semaphore];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    //æ·»åŠ ä»»åŠ¡2</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">        [self buyTicketWithCounts:2 taskName:@&quot;ä»»åŠ¡2&quot; semaphore:semaphore];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)buyTicketWithCounts:(int)counts taskName:(NSString *)taskName semaphore:(dispatch_semaphore_t)semaphore &#123;</span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">    for (int i = 0; i &lt; counts; i++) &#123;</span><br><span class="line">        if (self.movieTickets == 0) &#123;</span><br><span class="line">            NSLog(@&quot;%@ ç¥¨å·²å–å®Œ! %@&quot;, taskName, [NSThread currentThread]);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        NSLog(@&quot;%@ æŠ¢åˆ°%dç¥¨ å‰©ä½™%då¼ ç¥¨ %@&quot;, taskName, i + 1, --self.movieTickets, [NSThread currentThread]);</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_semaphore_signal(semaphore);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2017-10-16 test[23790:1042584] ä»»åŠ¡1 æŠ¢åˆ°1ç¥¨ å‰©ä½™2å¼ ç¥¨ &lt;NSThread: 0x604000465180&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[23790:1042584] ä»»åŠ¡1 æŠ¢åˆ°2ç¥¨ å‰©ä½™1å¼ ç¥¨ &lt;NSThread: 0x604000465180&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[23790:1042582] ä»»åŠ¡2 æŠ¢åˆ°1ç¥¨ å‰©ä½™0å¼ ç¥¨ &lt;NSThread: 0x604000464e00&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2017-10-16 test[23790:1042582] ä»»åŠ¡2 ç¥¨å·²å–å®Œ! &lt;NSThread: 0x604000464e00&gt;&#123;number = 4, name = (null)&#125;</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h2 id="2-pthread-mutex-äº’æ–¥é”"><a href="#2-pthread-mutex-äº’æ–¥é”" class="headerlink" title="2.pthread_mutex    äº’æ–¥é”"></a>2.pthread_mutex    äº’æ–¥é”</h2><p>åœ¨POSIXï¼ˆå¯ç§»æ¤æ“ä½œç³»ç»Ÿï¼‰ä¸­ï¼Œ<code>pthread_mutex</code>æ˜¯ä¸€å¥—ç”¨äºå¤šçº¿ç¨‹åŒæ­¥çš„mutexé”ï¼Œå¦‚åŒåä¸€æ ·ï¼Œä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼Œæ€§èƒ½æ¯”è¾ƒé«˜<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> //åˆå§‹åŒ–äº’æ–¥é”</span><br><span class="line">__block pthread_mutex_t _mutex;</span><br><span class="line">pthread_mutex_init(&amp;_mutex, NULL);</span><br><span class="line"></span><br><span class="line">//åˆ›å»ºé˜Ÿåˆ—ç»„</span><br><span class="line">dispatch_group_t group = dispatch_group_create();</span><br><span class="line"></span><br><span class="line">//åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—</span><br><span class="line">dispatch_queue_t concurrentQueue = dispatch_queue_create(&quot;my.concurrent.queue&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"></span><br><span class="line">//æ·»åŠ ä»»åŠ¡Aåˆ°é˜Ÿåˆ—ç»„</span><br><span class="line">dispatch_group_async(group, concurrentQueue, ^&#123;</span><br><span class="line">    pthread_mutex_lock(&amp;_mutex);</span><br><span class="line">    NSLog(@&quot;NSBlockOperation A %@&quot;, [NSThread currentThread]);</span><br><span class="line">    pthread_mutex_unlock(&amp;_mutex);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">//æ·»åŠ ä»»åŠ¡Båˆ°é˜Ÿåˆ—ç»„</span><br><span class="line">dispatch_group_async(group, concurrentQueue, ^&#123;</span><br><span class="line">    pthread_mutex_lock(&amp;_mutex);</span><br><span class="line">    NSLog(@&quot;NSBlockOperation B %@&quot;, [NSThread currentThread]);</span><br><span class="line">    pthread_mutex_unlock(&amp;_mutex);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">//ä»»åŠ¡æ‰§è¡Œå®Œï¼Œæ¥æ”¶åˆ°é€šçŸ¥</span><br><span class="line">dispatch_group_notify(group, concurrentQueue, ^&#123;</span><br><span class="line">    pthread_mutex_destroy(&amp;_mutex);</span><br><span class="line">    NSLog(@&quot;pthread_mutex_t has been destroyed!&quot;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>è¾“å‡ºç»“æœ:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2017-10-16 test[22982:1011384] NSBlockOperation B &lt;NSThread: 0x60000026a380&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[22982:1011382] NSBlockOperation A &lt;NSThread: 0x604000465ac0&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2017-10-16 test[22982:1011382] pthread_mutex_t has been destroyed!</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h2 id="3-NSLock-äº’æ–¥é”"><a href="#3-NSLock-äº’æ–¥é”" class="headerlink" title="3.NSLock  äº’æ–¥é”"></a>3.NSLock  äº’æ–¥é”</h2><p>åœ¨Cocoaä¸­<code>NSLock</code>æ˜¯ä¸€ç§ç®€å•çš„äº’æ–¥é”ï¼Œç»§æ‰¿è‡ª<code>NSLocking</code>åè®®ï¼Œå®šä¹‰äº†<code>lock</code>å’Œ<code>unlock</code>æ–¹æ³•ï¼Œ<br>è€Œ<code>NSLock</code>ç±»è¿˜å¢åŠ äº†<code>tryLock</code>å’Œ<code>lockBeforeDate:</code>æ–¹æ³•ã€‚</p>
<ul>
<li>1.<code>tryLock</code>æ–¹å¼è¯•å›¾è·å–ä¸€ä¸ªé”ï¼Œä½†æ˜¯å¦‚æœé”ä¸å¯ç”¨çš„æ—¶å€™ï¼Œå®ƒä¸ä¼šé˜»å¡çº¿ç¨‹ï¼Œç›¸åå®ƒåªä¼šè¿”å›NO</li>
<li>2.<code>lockBeforeDate:</code>æ–¹æ³•è¯•å›¾è·å–ä¸€ä¸ªé”ï¼Œä½†æ˜¯å¦‚æœé”æ²¡æœ‰åœ¨è§„å®šçš„æ—¶é—´å†…è¢«è·å¾—ï¼Œå®ƒä¼šä»é˜»å¡çŠ¶æ€å˜ä¸ºéé˜»å¡çŠ¶æ€ï¼Œè¿”å›NO</li>
<li>3.ä½¿ç”¨æ—¶ï¼Œæ³¨æ„<code>lock</code>å’Œ<code>unlock</code>æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œä¹Ÿå°±è¯´<code>lock</code>æ–¹æ³•è¿ç»­ä¸èƒ½è°ƒç”¨å¤šæ¬¡</li>
</ul>
<p>æˆ‘ä»¬è¿™é‡Œæ¥ä¸ªç®€å•çš„é¢˜ï¼š<br>å‡è®¾ä¸€å…±æœ‰5å¼ ç”µå½±ç¥¨ï¼Œ<br>ç°åœ¨æœ‰ä¸‰ä¸ªäººå»ä¹°ç¥¨ï¼Œæ¯äººè¦è´­ä¹°2å¼ ï¼Œ<br>ä¹Ÿå°±æ˜¯ä¸‰ä¸ªäººä¸€å…±è¦ä¹°6å¼ ç¥¨ï¼Œå¯æ˜¯æ€»ç”µå½±ç¥¨æ•°åªæœ‰5å¼ ï¼Œ<br>æ‰€ä»¥æœ€ç»ˆä»–ä»¬æœ‰ä¸€äººåªèƒ½ä¹°åˆ°ä¸€å¼ ç¥¨<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">- (void)example &#123;</span><br><span class="line">    //åˆ›å»ºé”çš„å¯¹è±¡</span><br><span class="line">    self.lock = [[NSLock alloc] init];</span><br><span class="line">    </span><br><span class="line">    //å‡è®¾æ€»å…±æœ‰5å¼ ç”µå½±ç¥¨</span><br><span class="line">    self.movieTickets = 5;</span><br><span class="line">    </span><br><span class="line">    //åˆ›å»ºä¸€ä¸ªå¹¶è¡Œé˜Ÿåˆ—</span><br><span class="line">    dispatch_queue_t myconcurrent = dispatch_queue_create(&quot;com.concurrent.queue.hello&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    </span><br><span class="line">    //Açº¿ç¨‹å¼‚æ­¥å¹¶è¡Œ ä¹°2å¼ ç¥¨</span><br><span class="line">    dispatch_async(myconcurrent, ^&#123;</span><br><span class="line">        [self buyTicketWithCounts:2 thread:@&quot;çº¿ç¨‹A&quot;];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    //Bçº¿ç¨‹å¼‚æ­¥å¹¶è¡Œ ä¹°2å¼ ç¥¨</span><br><span class="line">    dispatch_async(myconcurrent, ^&#123;</span><br><span class="line">        [self buyTicketWithCounts:2 thread:@&quot;çº¿ç¨‹B&quot;];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    //Cçº¿ç¨‹å¼‚æ­¥å¹¶è¡Œ ä¹°2å¼ ç¥¨</span><br><span class="line">    dispatch_async(myconcurrent, ^&#123;</span><br><span class="line">        [self buyTicketWithCounts:2 thread:@&quot;çº¿ç¨‹C&quot;];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)buyTicketWithCounts:(int)counts thread:(NSString *)threadName &#123;</span><br><span class="line">    [self.lock lock];</span><br><span class="line">    for (int i = 1; i &lt;= counts; i++) &#123;</span><br><span class="line">        if (self.movieTickets == 0) &#123;</span><br><span class="line">            NSLog(@&quot;ç¥¨å–å®Œäº† %@&quot;, threadName);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        NSLog(@&quot;å‰©ä½™ç¥¨æ•°ï¼š%d  %@ %@&quot;, self.movieTickets, threadName, [NSThread currentThread]);</span><br><span class="line">        self.movieTickets--;</span><br><span class="line">    &#125;</span><br><span class="line">    [self.lock unlock];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2017-10-16 test[20232:919739] å‰©ä½™ç¥¨æ•°ï¼š5  çº¿ç¨‹A &lt;NSThread: 0x600000468240&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[20232:919739] å‰©ä½™ç¥¨æ•°ï¼š4  çº¿ç¨‹A &lt;NSThread: 0x600000468240&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[20232:919738] å‰©ä½™ç¥¨æ•°ï¼š3  çº¿ç¨‹B &lt;NSThread: 0x60000007fa40&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2017-10-16 test[20232:919738] å‰©ä½™ç¥¨æ•°ï¼š2  çº¿ç¨‹B &lt;NSThread: 0x60000007fa40&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2017-10-16 test[20232:919745] å‰©ä½™ç¥¨æ•°ï¼š1  çº¿ç¨‹C &lt;NSThread: 0x6040004674c0&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">2017-10-16 test[20232:919745] ç¥¨å–å®Œäº† çº¿ç¨‹C</span><br></pre></td></tr></table></figure></p>
<p>ä¿è¯äº†æ€»ç¥¨æ•°5å¼ æ²¡æœ‰å˜ï¼Œæœ€ç»ˆæœ‰ä¸€ä¸ªäººåªèƒ½ä¹°åˆ°ä¸€å¼ ç¥¨</p>
<p><br></p>
<h2 id="4-NSCondition-ä¿¡å·é”"><a href="#4-NSCondition-ä¿¡å·é”" class="headerlink" title="4.NSCondition    ä¿¡å·é”"></a>4.NSCondition    ä¿¡å·é”</h2><p><code>NSCondition</code>ä¹Ÿæ˜¯æ´¾ç”Ÿè‡ª<code>NSLocking</code>, æ‰€ä»¥å®ƒå°±æœ‰<code>lock</code>å’Œ<code>unlock</code>æ–¹æ³•ï¼Œä½†æ˜¯<code>NSCondition</code>æœ¬èº«è¿˜æœ‰<code>wait</code>å’Œ<code>signal</code>æ–¹æ³•ï¼Œéå¸¸å¥½ç”¨ã€‚<br>æˆ‘ä»¬æ‹¿ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼æ¥ä¸¾ä¾‹å§</p>
<ul>
<li>1.æ¶ˆè´¹è€…è·å–é”ï¼Œå–äº§å“ï¼Œå¦‚æœæ²¡æœ‰å–åˆ°ï¼Œåˆ™<code>wait</code>ï¼Œè¿™æ—¶ä¼šé‡Šæ”¾é”ï¼ŒçŸ¥é“æœ‰çº¿ç¨‹å”¤é†’å®ƒå»æ¶ˆè´¹äº§å“</li>
<li>2.ç”Ÿäº§è€…åˆ¶é€ äº§å“ï¼Œé¦–å…ˆä¹Ÿè¦å–å¾—é”ï¼Œç„¶åç”Ÿäº§ï¼Œå†å‘<code>signal</code>ï¼Œè¿™æ ·å°±å¯ä»¥å”¤é†’æ­£åœ¨<code>wait</code>çš„çº¿ç¨‹çš„æ¶ˆè´¹è€…</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">- (void)ProducerConsumerPattern &#123;</span><br><span class="line">    self.products = [[NSMutableArray alloc] init];</span><br><span class="line">    </span><br><span class="line">    //åˆ›å»ºä¿¡å·é‡é”</span><br><span class="line">    NSCondition *condition = [[NSCondition alloc] init];</span><br><span class="line">    </span><br><span class="line">    //åˆ›å»ºä¸€ä¸ªå¹¶è¡Œé˜Ÿåˆ—</span><br><span class="line">    NSOperationQueue *myQueue = [[NSOperationQueue alloc] init];</span><br><span class="line">    </span><br><span class="line">    //æ¶ˆè´¹è€…</span><br><span class="line">    NSBlockOperation *consumer = [NSBlockOperation blockOperationWithBlock:^&#123;</span><br><span class="line">        [condition lock];</span><br><span class="line">        while (self.products.count == 0) &#123;</span><br><span class="line">            [condition wait]; //é˜»å¡ä½ï¼Œè®©çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°è¢«é€šçŸ¥åˆ°</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        NSLog(@&quot;Consumed a product which named %@ %@&quot;, self.products.firstObject, [NSThread currentThread]);</span><br><span class="line">        [condition unlock];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    //ç”Ÿäº§è€…</span><br><span class="line">    NSBlockOperation *producer = [NSBlockOperation blockOperationWithBlock:^&#123;</span><br><span class="line">        [condition lock];</span><br><span class="line">        </span><br><span class="line">        NSString *productName = [NSString stringWithFormat:@&quot;äº§å“-%ld&quot;, random()];</span><br><span class="line">        NSLog(@&quot;Produced a product %@ %@ &quot;, productName, [NSThread currentThread]);</span><br><span class="line">        [self.products addObject:productName];</span><br><span class="line">        </span><br><span class="line">        [condition signal];</span><br><span class="line">        [condition unlock];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [myQueue addOperation:producer];</span><br><span class="line">    [myQueue addOperation:consumer];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2017-10-16 test[24877:1088668] Produced a product äº§å“-1804289383 &lt;NSThread: 0x600000269a00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[24877:1088667] Consumed a product which named äº§å“-1804289383 &lt;NSThread: 0x604000278700&gt;&#123;number = 4, name = (null)&#125;</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h2 id="5-pthread-mutex-recursive-é€’å½’äº’æ–¥é”"><a href="#5-pthread-mutex-recursive-é€’å½’äº’æ–¥é”" class="headerlink" title="5.pthread_mutex(recursive)  é€’å½’äº’æ–¥é”"></a>5.pthread_mutex(recursive)  é€’å½’äº’æ–¥é”</h2><p>å…¶å®å°±æ˜¯ä¸€ä¸ªå‚æ•°æ¥æ–­å®š<code>pthread_mutex_t</code>æ˜¯å¦æ˜¯é€’å½’é”ï¼Œ<br>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹æ­»é”çš„ä¾‹å­<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (void)pthread_recursive_lock &#123;</span><br><span class="line">    __block pthread_mutex_t _mutext;</span><br><span class="line">    pthread_mutex_init(&amp;_mutext, NULL);</span><br><span class="line">    </span><br><span class="line">    dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">        static void (^MyBlock)(int);</span><br><span class="line">        MyBlock = ^(int value)&#123;</span><br><span class="line">            pthread_mutex_lock(&amp;_mutext); //ç¬¬äºŒæ¬¡è¿è¡Œåˆ°è¿™é‡Œä¼šé˜»å¡ä½ï¼Œäº§ç”Ÿæ­»é”ï¼Œå› ä¸ºä¹‹å‰è¢«é”ä½çš„èµ„æºè¿˜æœªè§£é”ï¼Œæ‰€ä»¥å°±é€ æˆå®ƒä»¬ä¿©äº’ç›¸ç­‰å¾…</span><br><span class="line">            if (value &gt; 0) &#123;</span><br><span class="line">                NSLog(@&quot;value = %d %@&quot;, value, [NSThread currentThread]);</span><br><span class="line">                MyBlock(value - 1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        MyBlock(5);</span><br><span class="line">        pthread_mutex_unlock(&amp;_mutext);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è§£å†³è¿™ä¸ªæ­»é”çš„é‡ç‚¹å°±æ˜¯ç»™pthread_mutex_tè®¾ç½®å±æ€§ä¸ºé€’å½’é”ï¼Œä»£ç å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (void)pthread_recursive_lock &#123;</span><br><span class="line"></span><br><span class="line">    //åˆ›å»ºäº’æ–¥é”çš„å±æ€§å¯¹è±¡ï¼Œå¹¶è®¾ç½®é€’å½’é”</span><br><span class="line">    pthread_mutexattr_t _mutexattr;</span><br><span class="line">    pthread_mutexattr_init(&amp;_mutexattr);</span><br><span class="line">    pthread_mutexattr_settype(&amp;_mutexattr, PTHREAD_MUTEX_RECURSIVE);</span><br><span class="line">    </span><br><span class="line">    //åˆ›å»ºäº’æ–¥é”å¯¹è±¡</span><br><span class="line">    __block pthread_mutex_t _mutext;</span><br><span class="line">    pthread_mutex_init(&amp;_mutext, &amp;_mutexattr);</span><br><span class="line">    </span><br><span class="line">    dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">        static void (^MyBlock)(int);</span><br><span class="line">        MyBlock = ^(int value)&#123;</span><br><span class="line">            pthread_mutex_lock(&amp;_mutext); //ç¬¬äºŒæ¬¡è¿è¡Œåˆ°è¿™é‡Œä¼šäº§ç”Ÿæ­»é”ï¼Œå› ä¸ºä¹‹å‰è¢«é”ä½çš„èµ„æºè¿˜æœªè§£é”ï¼Œæ‰€ä»¥å°±é€ æˆå®ƒä»¬ä¿©äº’ç›¸ç­‰å¾…</span><br><span class="line">            if (value &gt; 0) &#123;</span><br><span class="line">                NSLog(@&quot;value = %d %@&quot;, value, [NSThread currentThread]);</span><br><span class="line">                MyBlock(value - 1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        MyBlock(5);</span><br><span class="line">        pthread_mutex_unlock(&amp;_mutext);</span><br><span class="line">        pthread_mutex_destroy(&amp;_mutext);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2017-10-16 test[25369:1103912] value = 5 &lt;NSThread: 0x600000464a00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[25369:1103912] value = 4 &lt;NSThread: 0x600000464a00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[25369:1103912] value = 3 &lt;NSThread: 0x600000464a00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[25369:1103912] value = 2 &lt;NSThread: 0x600000464a00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[25369:1103912] value = 1 &lt;NSThread: 0x600000464a00&gt;&#123;number = 3, name = (null)&#125;</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h2 id="6-NSRecursiveLock-é€’å½’é”"><a href="#6-NSRecursiveLock-é€’å½’é”" class="headerlink" title="6.NSRecursiveLock  é€’å½’é”"></a>6.NSRecursiveLock  é€’å½’é”</h2><p><code>NSRecursiveLock</code>æ˜¯ä¸€ä¸ªé€’å½’é”ï¼Œå®ƒçš„<code>lock</code>æ–¹æ³•å¯ä»¥è¢«åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è¯·æ±‚ï¼Œè€Œä¸”ä¸ä¼šå¼•èµ·æ­»é”ï¼›<br>ä¸»è¦ç”¨åœ¨å¾ªç¯æˆ–è€…é€’å½’æ“ä½œä¸­ï¼Œå¤šæ¬¡<code>lock</code>ï¼Œåªéœ€è¦ä¸€æ¬¡<code>unlock</code>ï¼Œå› ä¸ºé€’å½’é”å†…éƒ¨ä¼šæœ‰ä¸€ä¸ªè·Ÿè¸ªè¢«<code>lock</code>çš„æ•°æ¬¡çš„åŠŸèƒ½ï¼Œ<br>ä¸ç®¡è¢«<code>lock</code>å¤šå°‘æ¬¡ï¼Œæœ€å<code>unlock</code>ä¹Ÿä¼šæŠŠæ‰€æœ‰çš„æŒæœ‰èµ„æºç»™è§£é”ï¼Œæ¥çœ‹ä¸€ä¸ªç»å…¸çš„æ­»é”æ¡ˆä¾‹ï¼Œå¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">NSLock *lock_i = [[NSLock alloc] init];</span><br><span class="line"></span><br><span class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">    static void (^MyBlock)(int);</span><br><span class="line">    MyBlock = ^(int value) &#123;</span><br><span class="line">        [lock_i lock]; //åŠ é”ä»£ç åœ¨é€’å½’æ‰§è¡Œç¬¬äºŒæ¬¡æ—¶é˜»å¡äº†ï¼Œä¹Ÿå°±æ˜¯æ­»é”äº†</span><br><span class="line">        if (value &gt; 0) &#123;</span><br><span class="line">            NSLog(@&quot;value = %d %@&quot;, value, [NSThread currentThread]);</span><br><span class="line">            sleep(2);</span><br><span class="line">            MyBlock(value - 1);</span><br><span class="line">        &#125;</span><br><span class="line">        [lock_i unlock];</span><br><span class="line">    &#125;;</span><br><span class="line">    MyBlock(5);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>çœ‹çœ‹è¿™ä¸ªä»£ç ï¼Œç”±äºåœ¨é€’å½’è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œ<code>[lock_i lock];</code>ä¼šè¢«å¤šæ¬¡è°ƒç”¨ï¼Œè€Œ<code>NSLock</code>æ¯æ¬¡<code>lock</code>å¯¹è±¡æ—¶ï¼Œå¿…é¡»æ˜¯<code>unlock</code>çŠ¶æ€ï¼Œ<br>æ‰€ä»¥å®ƒå°±ä¼šä¸€ç›´ç­‰ç€ä¸Šä¸€ä¸ª<code>lock</code>çš„å¯¹è±¡èµ„æºè¢«<code>unlock</code>æ‰ï¼Œä½†æ˜¯ä¸Šä¸€ä¸ªå¹¶æ²¡æœ‰æ‰§è¡Œ<code>unlock</code>ï¼Œæ‰€ä»¥å°±é€ æˆäº†ä»–ä»¬ä¹‹é—´äº’ç›¸ç­‰å¾…ï¼Œè€Œå½¢æˆæ­»é”ã€‚<br>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨é€’å½’é”<code>NSRecursiveLock</code>ï¼Œå› ä¸ºé€’å½’é”å¯ä»¥å¤šæ¬¡<code>lock</code>ï¼Œæœ€åä¸€æ¬¡<code>unlock</code>å°±èƒ½è§£é”æ‰€æœ‰å·²ç»è¢«<code>lock</code>çš„å¯¹è±¡<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">NSRecursiveLock *lock = [[NSRecursiveLock alloc] init];</span><br><span class="line"></span><br><span class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">    static void (^MyBlock)(int);</span><br><span class="line">    MyBlock = ^(int value) &#123;</span><br><span class="line">        [lock lock]; //è¿™è¡Œä»£ç åŠ é”æ‰§è¡Œäº†å¤šæ¬¡</span><br><span class="line">        if (value &gt; 0) &#123;</span><br><span class="line">            NSLog(@&quot;value = %d %@&quot;, value, [NSThread currentThread]);</span><br><span class="line">            sleep(2);</span><br><span class="line">            MyBlock(value - 1);</span><br><span class="line">        &#125;</span><br><span class="line">        [lock unlock];//è§£é”åªæ‰§è¡Œäº†ä¸€æ¬¡</span><br><span class="line">    &#125;;</span><br><span class="line">    MyBlock(5);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>è¾“å‡ºç»“æœä¸ºï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2017-10-16 test[21404:957416] value = 5 &lt;NSThread: 0x604000073280&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[21404:957416] value = 4 &lt;NSThread: 0x604000073280&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[21404:957416] value = 3 &lt;NSThread: 0x604000073280&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[21404:957416] value = 2 &lt;NSThread: 0x604000073280&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[21404:957416] value = 1 &lt;NSThread: 0x604000073280&gt;&#123;number = 3, name = (null)&#125;</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h2 id="7-NSConditionLock-æ¡ä»¶é”"><a href="#7-NSConditionLock-æ¡ä»¶é”" class="headerlink" title="7.NSConditionLock  æ¡ä»¶é”"></a>7.NSConditionLock  æ¡ä»¶é”</h2><p><code>NSConditionLock</code>å®šä¹‰äº†ä¸€ç»„å¯ä»¥æŒ‡å®š<code>intç±»å‹</code>æ¡ä»¶çš„äº’æ–¥é”<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">NSConditionLock *conditionLock = [[NSConditionLock alloc] initWithCondition:0];</span><br><span class="line"></span><br><span class="line">dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">    for (int i = 0; i &lt;= 3; i++) &#123;</span><br><span class="line">        [conditionLock lock];</span><br><span class="line">        NSLog(@&quot;A %d %@&quot;, i, [NSThread currentThread]);</span><br><span class="line">        sleep(1);</span><br><span class="line">        [conditionLock unlockWithCondition:i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, 0), ^&#123;</span><br><span class="line">    [conditionLock lock];</span><br><span class="line">    NSLog(@&quot;B %@&quot;,[NSThread currentThread]);</span><br><span class="line">    [conditionLock unlock];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h2 id="8-synchronized-äº’æ–¥é”"><a href="#8-synchronized-äº’æ–¥é”" class="headerlink" title="8.@synchronized  äº’æ–¥é”"></a>8.@synchronized  äº’æ–¥é”</h2><p>æˆ‘ä»¬è¿™é‡Œæ¥ä¸ªç®€å•çš„é¢˜ï¼š<br>å‡è®¾ä¸€å…±æœ‰5å¼ ç”µå½±ç¥¨ï¼Œ<br>ç°åœ¨æœ‰ä¸‰ä¸ªäººå»ä¹°ç¥¨ï¼Œæ¯äººè¦è´­ä¹°2å¼ ï¼Œ<br>ä¹Ÿå°±æ˜¯ä¸‰ä¸ªäººä¸€å…±è¦ä¹°6å¼ ç¥¨ï¼Œå¯æ˜¯æ€»ç”µå½±ç¥¨æ•°åªæœ‰5å¼ ï¼Œ<br>æ‰€ä»¥æœ€ç»ˆä»–ä»¬æœ‰ä¸€äººåªèƒ½ä¹°åˆ°ä¸€å¼ ç¥¨</p>
<p><code>@synchronized</code>å…³é”®å­—åŠ é”ï¼Œæ˜¯ä¸€ç§äº’æ–¥é”ï¼Œæ€§èƒ½è¾ƒå·®ä¸æ¨èä½¿ç”¨ï¼›çœ‹ä»£ç ç¤ºä¾‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">- (void)example &#123;</span><br><span class="line">    //å‡è®¾æ€»å…±æœ‰5å¼ ç”µå½±ç¥¨</span><br><span class="line">    self.movieTickets = 5;</span><br><span class="line">    </span><br><span class="line">    //åˆ›å»ºä¸€ä¸ªå¹¶è¡Œé˜Ÿåˆ—</span><br><span class="line">    dispatch_queue_t myconcurrent = dispatch_queue_create(&quot;com.concurrent.queue.hello&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    </span><br><span class="line">    //Açº¿ç¨‹å¼‚æ­¥å¹¶è¡Œ ä¹°2å¼ ç¥¨</span><br><span class="line">    dispatch_async(myconcurrent, ^&#123;</span><br><span class="line">        [self buyTicketWithCounts:2 thread:@&quot;çº¿ç¨‹A&quot;];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    //Bçº¿ç¨‹å¼‚æ­¥å¹¶è¡Œ ä¹°2å¼ ç¥¨</span><br><span class="line">    dispatch_async(myconcurrent, ^&#123;</span><br><span class="line">        [self buyTicketWithCounts:2 thread:@&quot;çº¿ç¨‹B&quot;];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    //Cçº¿ç¨‹å¼‚æ­¥å¹¶è¡Œ ä¹°2å¼ ç¥¨</span><br><span class="line">    dispatch_async(myconcurrent, ^&#123;</span><br><span class="line">        [self buyTicketWithCounts:2 thread:@&quot;çº¿ç¨‹C&quot;];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)buyTicketWithCounts:(int)counts thread:(NSString *)threadName &#123;</span><br><span class="line">    @synchronized(self) &#123;</span><br><span class="line">        for (int i = 1; i &lt;= counts; i++) &#123;</span><br><span class="line">            if (self.movieTickets == 0) &#123;</span><br><span class="line">                NSLog(@&quot;ç¥¨å–å®Œäº† %@&quot;, threadName);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            NSLog(@&quot;å‰©ä½™ç¥¨æ•°ï¼š%d  %@ %@&quot;, self.movieTickets, threadName, [NSThread currentThread]);</span><br><span class="line">            self.movieTickets--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>çŒœçŒœè¾“å‡ºç»“æœä¼šæ˜¯ä»€ä¹ˆï¼Ÿ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2017-10-16 test[19868:910931] å‰©ä½™ç¥¨æ•°ï¼š5  çº¿ç¨‹A &lt;NSThread: 0x600000270400&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[19868:910931] å‰©ä½™ç¥¨æ•°ï¼š4  çº¿ç¨‹A &lt;NSThread: 0x600000270400&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[19868:910928] å‰©ä½™ç¥¨æ•°ï¼š3  çº¿ç¨‹B &lt;NSThread: 0x600000270640&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2017-10-16 test[19868:910928] å‰©ä½™ç¥¨æ•°ï¼š2  çº¿ç¨‹B &lt;NSThread: 0x600000270640&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2017-10-16 test[19868:910930] å‰©ä½™ç¥¨æ•°ï¼š1  çº¿ç¨‹C &lt;NSThread: 0x6000002705c0&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">2017-10-16 test[19868:910930] ç¥¨å–å®Œäº† çº¿ç¨‹C</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œä¾‹å­è¯´æ˜ï¼Œæ€»ç¥¨æ•°5å¼ æ²¡æœ‰å˜ï¼Œå› ä¸ºä½¿ç”¨äº†<code>@synchronized</code>äº’æ–¥é”ï¼›å‡è®¾æ­¤æ—¶ï¼Œæˆ‘ä»¬ä¸ç”¨<code>@synchronized</code>ï¼Œä¼šè¾“å‡ºä»€ä¹ˆç»“æœäº†ï¼Ÿ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2017-10-16 test[19984:914005] å‰©ä½™ç¥¨æ•°ï¼š5  çº¿ç¨‹A &lt;NSThread: 0x604000067c40&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2017-10-16 test[19984:914004] å‰©ä½™ç¥¨æ•°ï¼š5  çº¿ç¨‹C &lt;NSThread: 0x600000276180&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[19984:914007] å‰©ä½™ç¥¨æ•°ï¼š5  çº¿ç¨‹B &lt;NSThread: 0x60400026c880&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">2017-10-16 test[19984:914005] å‰©ä½™ç¥¨æ•°ï¼š4  çº¿ç¨‹A &lt;NSThread: 0x604000067c40&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2017-10-16 test[19984:914004] å‰©ä½™ç¥¨æ•°ï¼š3  çº¿ç¨‹C &lt;NSThread: 0x600000276180&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2017-10-16 test[19984:914007] å‰©ä½™ç¥¨æ•°ï¼š2  çº¿ç¨‹B &lt;NSThread: 0x60400026c880&gt;&#123;number = 5, name = (null)&#125;</span><br></pre></td></tr></table></figure></p>
<p>çœ‹åˆ°æ²¡ï¼Œå–å‡ºäº†6å¼ ç¥¨ğŸ˜°</p>
<p><br><br><br><br><a href="/2017/10/15/GCDçš„ä¸€èˆ¬è®¤çŸ¥/">GCDçš„ä¸€èˆ¬è®¤çŸ¥ï¼Œæ‰“å¼€</a><br><a href="/2017/10/15/NSOperationçš„è®¤çŸ¥/">NSOperationçš„è®¤çŸ¥ï¼Œæ‰“å¼€</a><br><a href="/2017/10/15/NSThreadçš„è®¤çŸ¥/">NSThreadçš„è®¤çŸ¥</a><br><a href="/2017/10/15/iOSçš„Runloopè®¤çŸ¥/">iOSçš„Runloopè®¤çŸ¥ï¼Œæ‰“å¼€</a></p>


  </article>
  </script>
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <div class="busuanzi center">
    é¡µé˜…è¯»é‡:&nbsp;<span id="busuanzi_value_page_pv"></span>&nbsp;ãƒ»&nbsp;
    ç«™è®¿é—®é‡:&nbsp;<span id="busuanzi_value_site_pv"></span>&nbsp;ãƒ»&nbsp;
    ç«™è®¿å®¢æ•°:&nbsp;<span id="busuanzi_value_site_uv"></span>
  </div>




    </div>
  </div>
  <footer class="page-footer"><div class="clearfix">
</div>
<div class="right-foot container">
    <div class="firstrow">
        <a href="#top" target="_self">
        <svg class="i-caret-right" viewBox="0 0 32 32" width="24" height="24" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3">
            <path d="M10 30 L26 16 10 2 Z"></path>
        </svg>
        </a>
        Â© Victor Zhang 2014-2018
    </div>
    <div class="secondrow">
        <a href="https://github.com/gaoryrt/hexo-theme-pln">
        Theme Pln
        </a>
    </div>
</div>
<div class="clearfix">
</div>
</footer>
  <script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
<script src="/js/search.min.js"></script>
<script type="text/javascript">

// disqus scripts


// dropdown scripts
$(".dropdown").click(function(event) {
  var current = $(this);
  event.stopPropagation();
  $(current).children(".dropdown-content")[($(current).children(".dropdown-content").hasClass("open"))?'removeClass':'addClass']("open")
});
$(document).click(function(){
    $(".dropdown-content").removeClass("open");
})

var path = "/search.xml";
searchFunc(path, 'local-search-input', 'local-search-result');

</script>

</body>
</html>
